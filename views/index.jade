extends layout

block content
    table
        tr
            td
                table(class='resultDish')
                    tr
                        td
                            p(class='label') Белки
                            p(class='proteins item') 0
                        td
                            p(class='label') Жиры
                            p(class='triglyceride item') 0
                        td
                            p(class='label') Углеводы
                            p(class='carbohydrate item') 0
                        td
                            p(class='label') Ккал
                            p(class='calorie item') 0
            td
                div(class='daily')
                    div(class='result product')
                        p(class='label') Итог
                        p(class='proteins item') Белки
                        p(class='triglyceride item') Жиры
                        p(class='carbohydrate item') Углеводы
                        p(class='calorie item') Ккал
                    div(class='morning product')
                        p(class='label') Завтрак
                        input(class='proteins item' placeholder='Белки')
                        input(class='triglyceride item' placeholder='Жиры')
                        input(class='carbohydrate item' placeholder='Углеводы')
                        input(class='calorie item' placeholder='Ккал')
                    div(class='day product')
                        p(class='label') Ланч
                        input(class='proteins item' placeholder='Белки')
                        input(class='triglyceride item' placeholder='Жиры')
                        input(class='carbohydrate item' placeholder='Углеводы')
                        input(class='calorie item' placeholder='Ккал')
                    div(class='evening product')
                        p(class='label') Обед
                        input(class='proteins item' placeholder='Белки')
                        input(class='triglyceride item' placeholder='Жиры')
                        input(class='carbohydrate item' placeholder='Углеводы')
                        input(class='calorie item' placeholder='Ккал')
                    div(class='evening product')
                        p(class='label') Перекус
                        input(class='proteins item' placeholder='Белки')
                        input(class='triglyceride item' placeholder='Жиры')
                        input(class='carbohydrate item' placeholder='Углеводы')
                        input(class='calorie item' placeholder='Ккал')
                    div(class='evening product')
                        p(class='label') Ужин
                        input(class='proteins item' placeholder='Белки')
                        input(class='triglyceride item' placeholder='Жиры')
                        input(class='carbohydrate item' placeholder='Углеводы')
                        input(class='calorie item' placeholder='Ккал')
                    div(class='evening product')
                        p(class='label') Перед сном
                        input(class='proteins item' placeholder='Белки')
                        input(class='triglyceride item' placeholder='Жиры')
                        input(class='carbohydrate item' placeholder='Углеводы')
                        input(class='calorie item' placeholder='Ккал')
                    div(class='newItem product')
                        button(class='label addButton') +
                        input(class='proteins item' placeholder='Белки')
                        input(class='triglyceride item' placeholder='Жиры')
                        input(class='carbohydrate item' placeholder='Углеводы')
                        input(class='calorie item' placeholder='Ккал')

        tr
            table(class="table")
                tr
                    td
                        table(class='currentDishProducts')
                    td
                        div(class='newProduct')
                            button(class='addProductButton item') +
                            input(class='description item' placeholder='Описание')
                            input(class='proteins item' placeholder='Белки')
                            input(class='triglyceride item' placeholder='Жиры')
                            input(class='carbohydrate item' placeholder='Углеводы')
                            input(class='calorie item' placeholder='Ккал')
                        select(class='sortBy')
                            option(value="description" selected=) Имя
                            option(value="proteins") Белки
                            option(value="triglyceride") Жиры
                            option(value="carbohydrate") Углеводы
                            option(value="calorie") Каллории
                        select(class='sortOrder')
                            option(value="greater" selected) По возрастанию
                            option(value="lower") По убыванию


                        table(class='productsList')


    script.
        var templates = $('#templates');
        var addButton = $('.addProductButton');
        var newProduct = $('.newProduct');
        var productsList = $('.productsList');
        var products = [];
        var currentDishProducts = $('.currentDishProducts');
        var resultDish = $('.resultDish');
        var sortBy = $('.sortBy');
        var sortOrder = $('.sortOrder');

        var sortKey = sortBy.find('option:selected').val();
        var order = sortOrder.find('option:selected').val();

        $('.daily input').on('input propertychange paste',reCalcDaily);
        function reCalcDaily(){
            var res = {
                proteins: 0,
                triglyceride: 0,
                carbohydrate: 0,
                calorie: 0
            }
            var daily = $('.daily');
            daily.find('.proteins').each(function(){

                res.proteins += +$(this).val();
            });
            daily.find('.triglyceride').each(function () {
                res.triglyceride += +$(this).val();
            });
            daily.find('.carbohydrate').each(function () {
                res.carbohydrate += +$(this).val();
            });
            daily.find('.calorie').each(function () {
                res.calorie += +$(this).val();
            });
            var resEl = $('.result');
            resEl.find('.proteins').text(res.proteins + ' г');
            resEl.find('.triglyceride').text(res.triglyceride + ' г');
            resEl.find('.carbohydrate').text(res.carbohydrate + ' г');
            resEl.find('.calorie').text(res.calorie + ' Ккал');

        }
        $('.addButton').click(function(){
            var daily = $('.daily');
            var newItem = daily.find('.newItem').clone();

            newItem.find('button').text('-');
            newItem.find('button').click(removeFromCurrentDish.bind(null, newItem, reCalcDaily));
            newItem.removeClass('newItem');
            newItem.find('input').on('input propertychange paste',reCalcDaily);
            daily.find('.newItem').find('input').val('');

            daily.find('.newItem').before(newItem);
        });

        sortBy.on('change', function () {
            sortKey = sortBy.find('option:selected').val();
            updateList();
        });

        sortOrder.on('change', function () {
            order = sortOrder.find('option:selected').val();
            updateList();
        });

        getUpdates();

        newProduct.find('input:not(.description)').on('input propertychange paste', validateEl);

        function validateEl() {

            var el = $(this);
            var s = el.val();
            s.replace(',', '.');

            var n = parseInt(s);

            if(isNaN(n) || s === "") {
                el.css('background-color', 'red');
                return false;
            } else {
                el.val(s);
                el.css('background-color', 'green');
                return true;
            }
        }


        addButton.click(function(){

            if( !validateEl.bind(newProduct.find('.proteins'))() ||
                !validateEl.bind(newProduct.find('.triglyceride'))() ||
                !validateEl.bind(newProduct.find('.carbohydrate'))() ||
                !validateEl.bind(newProduct.find('.calorie'))()
            )
            {
                console.error("Wrong product");
                return;
            }

            var product = getProductFromInput(newProduct);
            $.post(window.location.href +  "newProduct", product)
                    .done(function () {
                        console.log("Product added");
                        newProduct.find('.item:not(button)').empty();
                        getUpdates();
                    })
                    .fail(function (error) {
                        console.log(error.responseText);
                    });
        });

        function getUpdates(){
            $.get(window.location.href + "list", function (data) {
                products = data;
                updateList();
            });
        }

        function getProductFromInput(item){
            return {
                description: item.find('.description').val(),
                proteins: item.find('.proteins').val() ,
                triglyceride: item.find('.triglyceride').val(),
                carbohydrate: item.find('.carbohydrate').val(),
                calorie: item.find('.calorie').val()
            }
        }
        function getProductFromP(item) {
            return {
                description: item.find('.description').text(),
                proteins: item.find('.proteins').text(),
                triglyceride: item.find('.triglyceride').text(),
                carbohydrate: item.find('.carbohydrate').text(),
                calorie: item.find('.calorie').text()
            }
        }

        function setProduct(view, product) {

            view.find('.description').text(product.description);
            view.find('.proteins').text(product.proteins);
            view.find('.triglyceride').text(product.triglyceride);
            view.find('.carbohydrate').text(product.carbohydrate);
            view.find('.calorie').text(product.calorie);
        }

        function removeFromCurrentDish(view, cb){
            view.detach();
            return cb && cb();
        }

        function addToCurrentDish(product){
            var productView = $('<tr>')
                .append($('<div>')
                    .addClass('product')
                    .append($('<td>')
                        .append($('<button>').addClass('item remove').text('-')))
                    .append($('<td>').addClass('description item'))
                    .append($('<td>').addClass('proteins item').text('-'))
                    .append($('<td>').addClass('triglyceride item').text('-'))
                    .append($('<td>').addClass('carbohydrate item').text('-'))
                    .append($('<td>').addClass('calorie item').text('-'))
                    .append($('<td>')
                        .append($('<input>').addClass('mass item').attr('placeholder', 'Вес').attr('value', '100').text('-')))
            );


            setProduct(productView, product);
            productView.find('.remove').click(removeFromCurrentDish.bind(null, productView, reCalc));

            productView.find('input').on('input propertychange paste', reCalc);

            productView.appendTo(currentDishProducts);

            reCalc();
        }

        function reCalc(){
            var res = {
                proteins: 0,
                triglyceride: 0,
                carbohydrate: 0,
                calorie: 0
            }
            currentDishProducts.find('.product').each(function(){
                var item = $(this);
                var product = getProductFromP(item);
                var mass = +(item.find('.mass').val()) / 100;

                res.proteins += +product.proteins * mass;
                res.triglyceride += +product.triglyceride * mass;
                res.carbohydrate += +product.carbohydrate * mass;
                res.calorie += +product.calorie * mass;
            });
            resultDish.find('.proteins').text(res.proteins + ' г');
            resultDish.find('.triglyceride').text(res.triglyceride + ' г');
            resultDish.find('.carbohydrate').text(res.carbohydrate + ' г');
            resultDish.find('.calorie').text(res.calorie + ' Ккал');
        }

        function updateList() {
            productsList.empty();

            if(order === 'greater') products = products.sort(function (p1, p2) {return p1[sortKey] > p2[sortKey];});
            else products = products.sort(function (p1, p2) {return p1[sortKey] < p2[sortKey];});

            for(var i = 0; i < products.length; i++){
                var product = products[i];

                var productView = $('<tr>')
                    .append($('<div>')
                        .append($('<td>')
                                .append($('<button></button>').addClass('item add').text('+')))
                        .append($('<td>').addClass('description item').text('Описание'))
                        .append($('<td>').addClass('proteins item').text('Белки'))
                        .append($('<td>').addClass('triglyceride item').text('Жиры'))
                        .append($('<td>').addClass('carbohydrate item').text('Углеводы'))
                        .append($('<td>').addClass('calorie item').text('Ккал'))
                        .addClass('product'));


                setProduct(productView, product);

                productView.find('.add').click(addToCurrentDish.bind(null, product));


                productView.appendTo(productsList);
            }
        }